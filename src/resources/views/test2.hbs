<!DOCTYPE html>
<html>

<head>
    <!-- Set meta -->

    <!-- Define character set used -->
    <meta charset="UTF-8">
    <!-- Set viewport so that the website looks good in all devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Link the css files -->
    <!-- Link to google font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">

    <!-- Link to OpenLayers libraries -->
    <link rel="stylesheet" href="/libs/v6.9.0/css/ol.css">
    <script src="/libs/v6.9.0/build/ol.js"></script>
    <script src="/js/rawgis.js"></script>
    <link rel="stylesheet" href="/css/rawgis.css">

    <!--Popup libs-->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <link rel="stylesheet" href="/libs/v6.9.0/apidoc/styles/bootstrap.min.css" type="text/css">
    <script src="/libs/v6.9.0/apidoc/scripts/bootstrap.bundle.min.js"></script>


    <!-- Set title of the website -->
    <title>Dữ liệu xã Cẩm Hoàng</title>
</head>

<body>

    <!-- Map Section -->
    <div id="map" style="height: 800px;width: 100%;"></div>
    <div id="popup"></div>



    <script>
        // Initial map with OSM Basemap
        var osm = new ol.layer.Tile({
            title: 'OpenStreetMap',
            type: 'base',
            visible: true,
            source: new ol.source.OSM()
        });

        // Add other basemaps to map
        var bingRoads = new ol.layer.Tile({
            title: 'Bing Maps—Roads',
            type: 'base',
            visible: false,
            source: new ol.source.BingMaps({
                key: 'AtXIDEb9gSKgDf8R95QcYmYIkhBjdTLPJd_fqz4uSvxNuk3dkqjt6oGLp10A29u0',
                imagerySet: 'Road'
            })
        });

        var bingAerial = new ol.layer.Tile({
            title: 'Bing Maps—Aerial',
            type: 'base',
            visible: false,
            source: new ol.source.BingMaps({
                key: 'AtXIDEb9gSKgDf8R95QcYmYIkhBjdTLPJd_fqz4uSvxNuk3dkqjt6oGLp10A29u0',
                imagerySet: 'Aerial'
            })
        });

        var bingAerialWithLabels = new ol.layer.Tile({
            title: 'Bing Maps—Aerial with Labels',
            type: 'base',
            visible: false,
            source: new ol.source.BingMaps({
                key: 'AtXIDEb9gSKgDf8R95QcYmYIkhBjdTLPJd_fqz4uSvxNuk3dkqjt6oGLp10A29u0',
                imagerySet: 'AerialWithLabels'
            })
        });
        //
        var googleLayerSatellite = new ol.layer.Tile({
            title: "Google Satellite",
            type: 'base',
            visible: false,
            source: new ol.source.XYZ({
                url: 'http://mt1.google.com/vt/lyrs=s&hl=pl&&x={x}&y={y}&z={z}'
            }),
        });

        // Query GIS data from Geoserver
        var li_source = new ol.source.Vector({
            loader: function (extent, resolution, projection) {
                var url = 'http://103.173.154.32:8088/geoserver/hoangcam/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=MCC:mcc-landside&maxFeatures=50&outputFormat=application%2Fjson';
                $.ajax({ url: url, dataType: 'jsonp' });
            }
        });

        var geojsonFormat = new ol.format.GeoJSON();
        function loadFeatures(response) {
            li_source.addFeatures(geojsonFormat.readFeatures(response, {
                dataProjection: 'EPSG:4326',
                featureProjection: 'EPSG:3857'
            }));
        }
        var MCC_li = new ol.layer.Vector({
            title: 'Các điểm quan trọng',
            source: li_source,
        });

        var MCC_communes = new ol.layer.Image({
            title: 'Địa giới hành chính xã Cẩm Hoàng',
            source: new ol.source.ImageWMS({
                url: 'http://localhost:8088/geoserver/camhoang/wms?service=WMS&version=1.1.0&request=GetMap&layers=camhoang%3Acamhoangdc_1&bbox=564182.125%2C2317466.0%2C564514.4375%2C2318014.0&width=465&height=768&srs=EPSG%3A3405&styles=&format=application/openlayers',
            })
        });

        var MCC_roads = new ol.layer.Image({
            title: 'Hệ thống giao thông xã Cẩm Hoàng',
            source: new ol.source.ImageWMS({
                url: 'http://localhost:8088/geoserver/camhoang/wms?service=WMS&version=1.1.0&request=GetMap&layers=camhoang%3Acamhoanggt_1&bbox=564226.375%2C2317495.5%2C564493.1875%2C2318003.0&width=403&height=768&srs=EPSG%3A3405&styles=&format=application/openlayers',
            })
        });
        var MCC_UyBan = new ol.layer.Image({
            title: 'Hệ thống uỷ ban xã Cẩm Hoàng',
            source: new ol.source.ImageWMS({
                url: 'http://localhost:8088/geoserver/camhoang/wms?service=WMS&version=1.1.0&request=GetMap&layers=camhoang%3Acamhoangub_1&bbox=564234.25%2C2317503.0%2C564510.3125%2C2318013.0&width=415&height=768&srs=EPSG%3A3405&styles=&format=application/openlayers',
            })
        });

        var MCC_lulc = new ol.layer.Image({
            // title: 'Dữ liệu uỷ ban xã',
            // source: new ol.source.ImageWMS({
            //   url: 'http://localhost:8088/geoserver/camhoang/wms?service=WMS&version=1.1.0&request=GetMap&layers=camhoang%3Acamhoangub_1&bbox=564234.25%2C2317503.0%2C564510.3125%2C2318013.0&width=415&height=768&srs=EPSG%3A3405&styles=&format=application/openlayers',
            // })
        });

        // Display basemaps and GIS data in map with basic functions
        var map = new ol.Map({
            target: document.getElementById('map'),
            layers: [
                new ol.layer.Group({
                    title: 'Bản đồ nền',
                    layers: [googleLayerSatellite, bingAerialWithLabels, bingAerial, bingRoads, osm]
                }),
                new ol.layer.Group({
                    title: 'Dữ liệu địa lý',
                    layers: [MCC_lulc, MCC_communes, MCC_roads, MCC_UyBan, MCC_li]
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([105.621, 20.958]),
                zoom: 17
            }),
            controls: ol.control.defaults().extend([
                new ol.control.ScaleLine(),
                new ol.control.FullScreen(),
                new ol.control.OverviewMap({ layers: [googleLayerSatellite, bingAerialWithLabels, bingAerial, bingRoads, osm] }),
                new ol.control.MousePosition({
                    coordinateFormat: ol.coordinate.createStringXY(3),
                    projection: 'EPSG:4326'
                })
            ])
        });

        // Functions
        var layerSwitcher = new ol.control.LayerSwitcher({});
        map.addControl(layerSwitcher);

        // Add popup
        var elementPopup = document.getElementById('popup');
        const popup = new ol.Overlay({
            element: elementPopup
        });
        map.addOverlay(popup);

        const element = popup.getElement();

        map.on("singleclick", function (evt) {

            var view = map.getView();
            var viewResolution = view.getResolution();
            var source = MCC_communes.getSource();
            var url = source.getFeatureInfoUrl(
                evt.coordinate,
                viewResolution,
                view.getProjection(),
                { INFO_FORMAT: "application/json", FEATURE_COUNT: 50 }
            );

            console.log(url)

            if (url) {
                $.ajax({
                    type: "POST",
                    url: url,
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (response) {
                        const data = response.features[0]?.properties
                        console.log(data)
                        const content = `<p>
                          Mã vùng: ${data.txtmemo} </br> 
                          Diện tích: ${parseFloat(data.shape_area).toFixed(2)}m\u00B2 </br>
                          Chủ sở hữu: ${data.chusd}
                        </p>`

                        $("#popup-content").html(content);
                        overlay.setPosition(evt.coordinate);

                        // 4. Hieenr thi noi bat doi tuong duocj chon dang vung: camhoangdc
                        var vectorSource = new ol.source.Vector({
                            features: new ol.format.GeoJSON().readFeatures(response),
                        });
                        vectorLayer.setSource(vectorSource);
                    },
                    error: (err) => {
                        console.log("vào err")
                    }
                });
            }
        });

        map.on('singleclick', function (event) {

            var feature = map.forEachFeatureAtPixel(event.pixel, function (feature) {
                return feature;
            })
            console.log(feature)

            var layer = map.forEachLayerAtPixel(event.pixel, function (layer) {
                return layer;
            })
            var pixel = event.pixel;
            var coord = map.getCoordinateFromPixel(pixel);
            popup.setPosition(coord);
            let popover = bootstrap.Popover.getInstance(element);
            if (popover) {
                popover.dispose();
            }
            if (feature) {
                content = '<b>Địa chỉ: </b>' + 'thôn ' + feature.get('Thon') + '</br>';
                content += '<b>Số lần điều tra: </b>' + feature.get('Sohieu_DKS') + '</br>';
                content += '<b>Thời điểm điều tra: </b>' + feature.get('Landslide_') + '</br>';
                console.log(content)
                popover = new bootstrap.Popover(element, {
                    animation: true,
                    container: element,
                    content: content,
                    html: true,
                    placement: 'top',
                    title: 'Thông tin' + ' ' + layer.get('title'),
                });
            }

            // console.log(pixel);


            // popover.show();

        });




    </script>

    <!-- <script src="map.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/elm-pep@1.0.6/dist/elm-pep.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>

</body>

</html>